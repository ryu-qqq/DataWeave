# **OpenAI 기반 테스트 코드 및 데이터 자동화 프레임워크**

이 저장소는 OpenAI API를 사용하여 테스트 코드 및 기타 데이터를 자동으로 생성하기 위한 객체와 모듈로 구성되어 있습니다. 이 프레임워크는 배치 처리, 결과 관리, 동적 프롬프트 생성을 통해 개발 작업의 효율성과 확장성을 보장합니다.

---

## **개요**

### **핵심 기능**
- OpenAI API를 활용한 데이터 자동 생성
- 대규모 작업 처리를 위한 배치 프레임워크
- 데이터 유형에 맞춘 동적 프롬프트 생성
- S3 업로드 및 결과 관리
- 실패한 배치를 위한 유연한 재시도 메커니즘
- 배치 데이터 유형에 따라 동적으로 데이터를 가져오는 기능 제공

---

## **주요 구성 요소**

### **1. 모델**

- **`Batch`**: 
  - 처리 중인 단일 배치를 나타냅니다.
  - 상태, 재시도 횟수, S3 URL, 반복(iteration)과 같은 메타데이터를 추적합니다.
  
- **`BatchFile`**: 
  - 배치에서 처리할 파일을 나타냅니다.

- **`ProcessedBatchData`**: 
  - 처리된 결과를 저장하며 메타데이터와 S3 객체 이름을 포함합니다.

- **`UploadedBatchInfo`**: 
  - 업로드된 배치의 세부 정보(배치 ID 및 S3 URL)를 포함합니다.

- **`Prompt`**:
  - OpenAI API에 전송되는 요청 메시지를 나타냅니다.
  - 배치 제출을 위한 JSONL 형식으로 변환됩니다.

---

### **2. 배치 처리 워크플로우**

#### **`BatchProcessor`**
- 배치의 초기 처리를 담당합니다.
- **주요 단계**:
  1. **`DataFetcherStrategy`**를 사용하여 배치 데이터 유형에 따라 동적으로 데이터를 가져오기
  2. 데이터를 적절한 전략으로 매핑하여 프롬프트 생성
  3. 배치 파일 생성 및 OpenAI에 제출
  4. 재시도 추적 및 배치 상태 업데이트

#### **`CompletedBatchHandler`**
- **`PRE_COMPLETED`** 상태의 배치를 처리합니다.
- **주요 단계**:
  1. OpenAI에서 결과 다운로드
  2. 정의된 전략에 따라 결과 처리
  3. 처리된 결과를 S3에 업로드하고 해당 URL 반환
  4. 배치 상태를 **`READY_FOR_REVIEW`**로 업데이트

#### **`BatchStatusChecker`**
- 배치 상태를 모니터링합니다.
- **주요 단계**:
  1. **`PROCESSING`** 상태의 배치를 확인
  2. 배치 상태를 **`PRE_COMPLETED`**, **`FAILED`**로 업데이트하거나 필요한 경우 재시도

---

### **3. 프롬프트 생성**

#### **`PromptGeneratorFactory`**
- 각 데이터 유형에 맞는 프롬프트 생성기를 제공합니다.
- **지원 전략**:
  - 테스트 코드 생성
  - 제품 데이터 생성

#### **프롬프트 생성기**
- **`TestCodePromptGenerator`**: 테스트 코드 생성을 위한 프롬프트 생성
- **`ProductPromptGenerator`**: 제품 관련 데이터 생성을 위한 프롬프트 생성

---

### **4. S3 관리**

#### **`BatchUploadManager`**
- 처리된 결과를 S3에 업로드
- 각 배치를 고유한 S3 URL에 연결

#### **S3 URL 구조**
- **도메인**: `https://d3fej89xf1vai5.cloudfront.net/`
- **경로**: `batch/<data_type>/<batch_id>/<object_name>`

---

### **5. 배치 관리**

#### **`BatchIdManager`**
- 배치의 상태와 메타데이터를 관리합니다.
- Redis를 활용하여 배치 정보를 저장 및 조회합니다.
- **주요 기능**:
  - 배치 상태 업데이트
  - 특정 상태의 배치 목록 조회
  - 배치 삭제 및 재시도 횟수 관리

#### **`BatchFileCreator`**
- 데이터를 기반으로 배치 파일을 생성합니다.
- **주요 기능**:
  - OpenAI JSONL 형식으로 프롬프트 저장
  - 배치 파일 경로와 메타데이터를 포함하여 생성

---

## **처리 흐름**

### **1. 배치 초기화**
- **`BatchProcessor`**가 데이터를 가져오고, 프롬프트를 생성하며, 배치를 OpenAI에 제출합니다.

### **2. 배치 모니터링**
- **`BatchStatusChecker`**가 제출된 배치의 진행 상황을 확인하고 상태를 업데이트합니다.

### **3. 결과 처리**
- **`CompletedBatchHandler`**가 **`PRE_COMPLETED`** 상태의 배치를 처리하고 결과를 S3에 업로드합니다.
- 업로드된 S3 URL을 배치에 저장하여 추적 가능하도록 합니다.

### **4. 검토 및 최종화**
- **`READY_FOR_REVIEW`** 상태의 배치를 검토하는 별도의 DAG 또는 수동 프로세스를 통해 배치를 검토합니다.
- 기준을 충족하면 배치를 **`COMPLETED`**로 설정하거나 필요한 경우 재시도를 트리거합니다.

---

## **배치 상태 워크플로우**

| **상태**           | **설명**                                        |
|---------------------|------------------------------------------------|
| **PENDING**         | 배치가 초기화되었으나 아직 처리되지 않음          |
| **PROCESSING**      | 배치가 현재 처리 중                             |
| **PRE_COMPLETED**   | 결과가 준비되었으나 아직 처리되지 않음           |
| **READY_FOR_REVIEW**| 결과가 처리되어 검토 준비 완료                  |
| **COMPLETED**       | 배치가 성공적으로 처리되고 검토 완료            |
| **FAILED**          | 처리 중 또는 업로드 중 배치가 실패함            |
| **EXHAUSTED**       | 재시도 한도를 초과한 배치                       |

---

## **오류 처리**

- **재시도**:
  - 실패한 배치는 `max_retries`에 따라 최대 재시도됩니다.
  - 재시도 한도를 초과한 배치는 **`EXHAUSTED`**로 설정됩니다.

- **로깅**:
  - 각 단계에서 오류와 프로세스 세부 정보가 로깅됩니다.
  - 디버그 수준의 로그를 통해 세부적인 문제 해결 가능.

---